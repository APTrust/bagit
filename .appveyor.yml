version: "0.1.8.$($env:APPVEYOR_REPO_COMMIT.substring(0,7))-Windows"

platform: x64

init:
  - git config --global core.autocrlf input
  - ps: Update-AppveyorBuild -Version "0.1.8.$($env:APPVEYOR_REPO_COMMIT.substring(0,7))-Windows"
  #  - set BUILDVER=%APPVEYOR_BUILD_VERSION%.$($env:APPVEYOR_REPO_COMMIT.substring(0,7))

cache:
  - electron\node_modules
  - '%APPDATA%\npm-cache'
  - '%USERPROFILE%\.electron'

branches:
  only:
    - master

clone_folder: c:\gopath\src\github.com\APTrust\dart

environment:
  GOPATH: c:\gopath
  access_token:
    secure: "0muZEDVGEpw8OhnyWFnafYkUgrt+7kl6MdWEA2guW8oLX6s3dMoRrhQjuF3Sbpi5"
  artifactName: DART.Setup.0.1.8.$(APPVEYOR_BUILD_VERSION).$(APPVEYOR_REPO_COMMIT).exe

install:
  - ps: Install-Product node 8 x64
  - git reset --hard HEAD
  - npm install npm -g
  - npm install --prefix ./electron electron-builder@next # force install next version to test electron-builder
  - cd electron && npm install
  - echo %PATH%
  - echo %GOPATH%
  - set PATH=%GOPATH%\bin;c:\go\bin;%PATH%
  - set PATH=%APPVEYOR_BUILD_FOLDER%/electron/node_modules/.bin;%PATH%

build_script:
  - npm run --prefix ./electron
  - cd %APPVEYOR_BUILD_FOLDER%/electron && electron-builder . --em.version=%APPVEYOR_BUILD_VERSION%

artifacts:
  - path: electron/dist/*.exe
    name: DART-Windows

test: off
deploy:
  release: v$(appveyor_build_version)
  description: 'APTrust Digital Asset Routing Tool'
  provider: GitHub
  auth_token:
    secure: "0muZEDVGEpw8OhnyWFnafYkUgrt+7kl6MdWEA2guW8oLX6s3dMoRrhQjuF3Sbpi5"
  artifact: DART-Windows
  skip_tags: true
  draft: false
  prerelease: false

notifications:
  - provider: Slack
    incoming_webhook:
      secure: wQc/CYuw0WsjVvpj92QtP6//CzBNp/eFYpvlxiH6lIdhCbrh+cgQ3vExTygXJFA3xPg0attMwE/dOWipSS+vsk0EGsf0iipIaf/133/1RgQ=
    on_build_success: false
    on_build_failure: true
    on_build_status_changed: true
