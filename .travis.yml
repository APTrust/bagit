
os: osx
osx_image: xcode9.2

sudo: false

language: node_js
node_js: "9"
environment:
  - ELECTRON_CACHE=$HOME/.cache/electron
  - ELECTRON_BUILDER_CACHE=$HOME/.cache/electron-builder

cache:
  directories:
  - electron/node_modules
  - $HOME/.cache/electron
  - $HOME/.cache/electron-builder
  - $HOME/.npm/_prebuilds

environment:
  - access_token:
        secure:  pJmtCY7+qzctn9m6UejaJGlls3IMl8p2Tb3DjypHL+8DLmNNHK0jQZmZbb4sIJgM
before_install:
  - |
    if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      mkdir -p /tmp/git-lfs && curl -L https://github.com/github/git-lfs/releases/download/v2.3.1/git-lfs-$([ "$TRAVIS_OS_NAME" == "linux" ] && echo "linux" || echo "darwin")-amd64-2.3.1.tar.gz | tar -xz -C /tmp/git-lfs --strip-components 1
      export PATH="/tmp/git-lfs:$PATH"
    fi

install:
  - yarn

before_script:
  - git lfs pull

script:
  - if [[ "$TRAVIS_BRANCH" == "refactor" ]]; then cd refactor && npm test && cd ..; fi
  - if [[ "$TRAVIS_OS_NAME" == "linux" ]]; then cd electron && yarn ; fi
  - buildver="$(grep version electron/package.json |sed "s/[^0-9.]//g").$(git log --format=%h -1)"
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then cd electron && yarn && electron-builder -p never --em.version=$buildver; fi

before_deploy:
      - git config --local user.name "APTdeploy"
      - git config --local user.email "ops@aptrust.org"
      - git tag "v$(grep version electron/package.json |sed 's/[^0-9.]//g').$(git log --format=%h -1).$TRAVIS_BUILD_NUMBER"
deploy:
  provider: releases
  api_key:
    secure: 1RQHlxSWvh7QFV1rAhPnd+0bNWDPOV6XVbBoFXA1Oa2nXKthjBkmc4OTo2CNFpC1k1Wn4zW8SAduzMr9jG9f2HG+imWsy6IkRh3wUMLcE9RgfYDmaFOfwhqbjtoS+dQhBis3kI5YmhLDOaCD7BDuVttVGil8ZMpcGY1xWVPgBQRFlE71IssNEyOfxYhl1/njoT4nEaL/s/C5P+p1fKc+HlbdLpdpfnYRDs90NpqZuJKM4JzNWIECWoZqZY94cPLe9Czog1ijZvJbCQ0yGXOE70yWQN5KE9yk40JVbBdOBcfgzgbyAFCl+xvVj6v4TRuqRDL6tsF8SahPNdSdme0lOl8hegxeWfzmCjanY/Qnuh1Jk+JYy0hmUiLZgm+KPAjW0+LgFhPSO7QpPUA13UAWf05JrnvRIAyC0jfw48kQjuxd85cT1jQ8v6aii+m1GxbIOTsifBdG87b5dASN8ykSQUDT6UhOBbXplR6fwD2qM6UZa9TqiFhmvce12Jojff8BeUq8ZsXDo776PII9djJxE9z3SOkSg+omXn0DoRkt5gghdix+t5q5lmezUMBaTp3k+ozb8CO1rDzKqSfzQ8KEGUms/UGZi+NBbMbcwgCFJODykNOnnS6Mk0n+ztsj63x7t59nQuavsG4E8RS1888bPC1dncBMGjZqA/wthw+NRcw=
  file_glob: true
  file: electron/dist/*
  skip_cleanup: true
  overwrite: true
  on:
    branch: master

notifications:
  slack:
    secure: IWHP3fVK8/YJ9xmMQyz6zj0PnxI2pEkRgpZJUpSORHjGZFG5sGcmhb5DV2jtjY4YxQzQud7F7ZuFBzY+7yaTCnJC+tNAFzcmpgZBcxPiTfWIsWcbft1ITJtV/u+k25MVKW4YpZNpG51UInuncYLLpEZlflix322C97MtsgrZUpmWnmBEVemQ89UwaQ/SZpk6FXWPMzoGlaxr/ZF6JdsYuFHxm1/WurrpEuIRxj0TorQHqmsdgZPTK7Gg864RCKkE+55kFxTNRssZ0SmD7mWzEvHgosy+X/E8lch59qt5YFxT2tFNSzggGFATrY2VyVVl234pnlU1p2weDOdmhY8YB8PXFLkxipGmwNwaTQupzyHHj74WT9dL+1bNkbgAM+208gPa5VxaPKOgV59Z/PnuLpPIRZ8EFPJ5r/um84WjIlbQkrUkubUdlUbCc+e6bSBn5LaOJsDhonwumRk2XoKcCZLO92zZmIvlO84i/PiUvqRIG6SaLEIj081jVDYhm0o2WlnKTSKWxbCGq70L/3LSTtAjFBYELtLiYI0euYlgxskn89OtEHsPzIvVPQyfNvIie8WZ/rYKn+psoiPSVy89v8g2UZRejj0/z0jJf/MQ33s5+Z1TV3wE3QuYA6yNlViMRTUlvRLuaPwlq3A0meS7JZSsMIDjkbp9J9YlzGqw7Is=
    on_success: always
  email:
    on_failure: never
    on_success: never
