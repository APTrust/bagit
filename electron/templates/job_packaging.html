<div id="div-files" class="jumbotron">
  <h2>Packaging</h2>

  <form>
    {{> inputText field = form.fields.bagName }}

    <div style="margin-bottom:12px;">
      <div id="nameHintAPTrust" style="display:none">
        <small class="form-text text-muted">
          APTrust bag names must begin with your domain name, followed by a dot and a name.
        </small>
      </div>
      <div id="nameHintDPN" style="display:none">
        <small class="form-text text-muted">
          DPN bag names must be version 4 UUIDs.
        </small>
      </div>
    </div>

    {{> inputSelect field = form.fields.profile }}

  </form>

</div>

<div class="pull-right" id="btnJobStorageDiv">
  <a class="btn btn-primary" id="btnJobTagsOrStorage" role="button">Next &gt;&gt;</a>
</div>

<div class="pull-left" id="btnJobFilesDiv">
  <a class="btn btn-primary" id="btnJobFiles" role="button">&lt;&lt; Previous</a>
</div>


<script>
    $('[data-toggle="popover"]').popover();

    $("select[name=profile]").change(function() {
        hideBagNameHint();
        var job = window.es.ActiveObject;
        var bagNameOnForm = $('#bagName').val();
        var id = $("select[name=profile]").val();
        if (id == "") {
            job.bagItProfile = null;
            $('#bagName').val(`Bag-${Date.now()}`);
        } else {
            job.bagItProfile = window.es.BagItProfile.find(id);
            var name = $('#bagName').val() || job.bagItProfile.bagName;
            if (!job.bagItProfile.isValidBagName(name)) {
                job.bagName = job.bagItProfile.suggestBagName();
                $('#bagName').val(job.bagName);
            }
            showBagNameHint();
        }
    });

    $("#btnJobFiles").click(function() {
        var job = es.ActiveObject;
        job.save();
        $("#container").html(es.ViewCache['jobFiles']);
    });

    $("#btnJobTagsOrStorage").click(function() {
        var job = es.ActiveObject;
        job.bagName = $('#bagName').val();

        // Make sure bag name is valid before moving forward.
        var name = $('#bagName').val();
        var parent = $('#bagName').closest("div.form-group");
        if (job.bagItProfile != null) {
            if (job.bagItProfile.isValidBagName(name)) {
                parent.removeClass("has-error");
                parent.addClass("has-success");
                hideBagNameHint();
                job.bagName = name;
            } else {
                parent.removeClass("has-success");
                parent.addClass("has-error");
                showBagNameHint();
                return;
            }
        }

        // Bag name is valid.
        job.save();
        var data = {};
        if (job.bagItProfile == null) {
            // Show storage options
        } else {
            // Show tag editor
            var tags = job.bagItProfile.tagsGroupedByFile();
            data['tags'] = tags;
            data['tagContext'] = 'Job';
            $("#container").html(templates.jobTags(data));
        }
    });

    function showBagNameHint() {
        var job = es.ActiveObject;
        if (job.bagItProfile.hasRequiredTagFile("aptrust-info.txt")) {
            $('#nameHintAPTrust').show();
        } else if (job.bagItProfile.hasRequiredTagFile("dpn-tags/dpn-info.txt")) {
            $('#nameHintDPN').show();
        }
    }

    function hideBagNameHint() {
        $('#nameHintAPTrust').hide();
        $('#nameHintDPN').hide();
    }

</script>
