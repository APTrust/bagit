

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      bagit/bagger.js - Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">
      Braintree SDK Client Reference
    </h3>

    

    <h3>Classes</h3><ul><li id="AppSetting-nav"><a href="AppSetting.html">AppSetting</a><ul class='methods'><li data-type="method" id="AppSetting-validate-nav"><a href="AppSetting.html#validate">validate</a></li></ul></li><li id="APTrustClient-nav"><a href="APTrustClient.html">APTrustClient</a><ul class='methods'><li data-type="method" id="APTrustClient-description-nav"><a href="APTrustClient.html#.description">description</a></li></ul></li><li id="APTrustSetup-nav"><a href="APTrustSetup.html">APTrustSetup</a><ul class='methods'><li data-type="method" id="APTrustSetup-description-nav"><a href="APTrustSetup.html#.description">description</a></li></ul></li><li id="BagItUtil-nav"><a href="BagItUtil.html">BagItUtil</a><ul class='methods'><li data-type="method" id="BagItUtil-profileFromBuiltIn-nav"><a href="BagItUtil.html#.profileFromBuiltIn">profileFromBuiltIn</a></li><li data-type="method" id="BagItUtil-profileFromStandardJson-nav"><a href="BagItUtil.html#.profileFromStandardJson">profileFromStandardJson</a></li><li data-type="method" id="BagItUtil-profileFromStandardObject-nav"><a href="BagItUtil.html#.profileFromStandardObject">profileFromStandardObject</a></li></ul></li><li id="DartProcess-nav"><a href="DartProcess.html">DartProcess</a></li><li id="FileSystemReader-nav"><a href="FileSystemReader.html">FileSystemReader</a><ul class='methods'><li data-type="method" id="FileSystemReader-description-nav"><a href="FileSystemReader.html#.description">description</a></li><li data-type="method" id="FileSystemReader-list-nav"><a href="FileSystemReader.html#list">list</a></li><li data-type="method" id="FileSystemReader-read-nav"><a href="FileSystemReader.html#read">read</a></li></ul></li><li id="FileSystemWriter-nav"><a href="FileSystemWriter.html">FileSystemWriter</a><ul class='methods'><li data-type="method" id="FileSystemWriter-description-nav"><a href="FileSystemWriter.html#.description">description</a></li><li data-type="method" id="FileSystemWriter-add-nav"><a href="FileSystemWriter.html#add">add</a></li></ul></li><li id="Form-nav"><a href="Form.html">Form</a><ul class='methods'><li data-type="method" id="Form-_initField-nav"><a href="Form.html#_initField">_initField</a></li><li data-type="method" id="Form-_initFields-nav"><a href="Form.html#_initFields">_initFields</a></li><li data-type="method" id="Form-castNewValueToType-nav"><a href="Form.html#castNewValueToType">castNewValueToType</a></li><li data-type="method" id="Form-hasErrors-nav"><a href="Form.html#hasErrors">hasErrors</a></li><li data-type="method" id="Form-parseFromDOM-nav"><a href="Form.html#parseFromDOM">parseFromDOM</a></li><li data-type="method" id="Form-setErrors-nav"><a href="Form.html#setErrors">setErrors</a></li></ul></li><li id="GlobalContext-nav"><a href="GlobalContext.html">GlobalContext</a><ul class='methods'><li data-type="method" id="GlobalContext-dartVersion-nav"><a href="GlobalContext.html#dartVersion">dartVersion</a></li><li data-type="method" id="GlobalContext-db-nav"><a href="GlobalContext.html#db">db</a></li><li data-type="method" id="GlobalContext-electronIsRunning-nav"><a href="GlobalContext.html#electronIsRunning">electronIsRunning</a></li><li data-type="method" id="GlobalContext-getPackageInfo-nav"><a href="GlobalContext.html#getPackageInfo">getPackageInfo</a></li><li data-type="method" id="GlobalContext-isElectronDevMode-nav"><a href="GlobalContext.html#isElectronDevMode">isElectronDevMode</a></li></ul></li><li id="InternalSetting-nav"><a href="InternalSetting.html">InternalSetting</a><ul class='methods'><li data-type="method" id="InternalSetting-validate-nav"><a href="InternalSetting.html#validate">validate</a></li></ul></li><li id="Job-nav"><a href="Job.html">Job</a><ul class='methods'><li data-type="method" id="Job-find-nav"><a href="Job.html#.find">find</a></li><li data-type="method" id="Job-inflateFrom-nav"><a href="Job.html#.inflateFrom">inflateFrom</a></li><li data-type="method" id="Job-inflateFromFile-nav"><a href="Job.html#.inflateFromFile">inflateFromFile</a></li><li data-type="method" id="Job-packageAttempted-nav"><a href="Job.html#packageAttempted">packageAttempted</a></li><li data-type="method" id="Job-packagedAt-nav"><a href="Job.html#packagedAt">packagedAt</a></li><li data-type="method" id="Job-packageSucceeded-nav"><a href="Job.html#packageSucceeded">packageSucceeded</a></li><li data-type="method" id="Job-title-nav"><a href="Job.html#title">title</a></li><li data-type="method" id="Job-uploadAttempted-nav"><a href="Job.html#uploadAttempted">uploadAttempted</a></li><li data-type="method" id="Job-uploadedAt-nav"><a href="Job.html#uploadedAt">uploadedAt</a></li><li data-type="method" id="Job-uploadSucceeded-nav"><a href="Job.html#uploadSucceeded">uploadSucceeded</a></li><li data-type="method" id="Job-validate-nav"><a href="Job.html#validate">validate</a></li><li data-type="method" id="Job-validatedAt-nav"><a href="Job.html#validatedAt">validatedAt</a></li><li data-type="method" id="Job-validationAttempted-nav"><a href="Job.html#validationAttempted">validationAttempted</a></li><li data-type="method" id="Job-validationSucceeded-nav"><a href="Job.html#validationSucceeded">validationSucceeded</a></li></ul></li><li id="JsonStore-nav"><a href="JsonStore.html">JsonStore</a></li><li id="ManifestEntry-nav"><a href="ManifestEntry.html">ManifestEntry</a><ul class='methods'><li data-type="method" id="ManifestEntry-validate-nav"><a href="ManifestEntry.html#validate">validate</a></li></ul></li><li id="OperationResult-nav"><a href="OperationResult.html">OperationResult</a><ul class='methods'><li data-type="method" id="OperationResult-inflateFrom-nav"><a href="OperationResult.html#.inflateFrom">inflateFrom</a></li><li data-type="method" id="OperationResult-finish-nav"><a href="OperationResult.html#finish">finish</a></li><li data-type="method" id="OperationResult-firstError-nav"><a href="OperationResult.html#firstError">firstError</a></li><li data-type="method" id="OperationResult-hasErrors-nav"><a href="OperationResult.html#hasErrors">hasErrors</a></li><li data-type="method" id="OperationResult-lastError-nav"><a href="OperationResult.html#lastError">lastError</a></li><li data-type="method" id="OperationResult-reset-nav"><a href="OperationResult.html#reset">reset</a></li><li data-type="method" id="OperationResult-start-nav"><a href="OperationResult.html#start">start</a></li><li data-type="method" id="OperationResult-succeeded-nav"><a href="OperationResult.html#succeeded">succeeded</a></li></ul></li><li id="PackageOperation-nav"><a href="PackageOperation.html">PackageOperation</a><ul class='methods'><li data-type="method" id="PackageOperation-inflateFrom-nav"><a href="PackageOperation.html#.inflateFrom">inflateFrom</a></li><li data-type="method" id="PackageOperation-getWriter-nav"><a href="PackageOperation.html#getWriter">getWriter</a></li><li data-type="method" id="PackageOperation-pruneSourceFilesUnlessJobCompleted-nav"><a href="PackageOperation.html#pruneSourceFilesUnlessJobCompleted">pruneSourceFilesUnlessJobCompleted</a></li><li data-type="method" id="PackageOperation-validate-nav"><a href="PackageOperation.html#validate">validate</a></li></ul></li><li id="PersistentObject-nav"><a href="PersistentObject.html">PersistentObject</a><ul class='methods'><li data-type="method" id="PersistentObject-find-nav"><a href="PersistentObject.html#.find">find</a></li><li data-type="method" id="PersistentObject-findMatching-nav"><a href="PersistentObject.html#.findMatching">findMatching</a></li><li data-type="method" id="PersistentObject-first-nav"><a href="PersistentObject.html#.first">first</a></li><li data-type="method" id="PersistentObject-firstMatching-nav"><a href="PersistentObject.html#.firstMatching">firstMatching</a></li><li data-type="method" id="PersistentObject-list-nav"><a href="PersistentObject.html#.list">list</a></li><li data-type="method" id="PersistentObject-mergeDefaultOpts-nav"><a href="PersistentObject.html#.mergeDefaultOpts">mergeDefaultOpts</a></li><li data-type="method" id="PersistentObject-sort-nav"><a href="PersistentObject.html#.sort">sort</a></li><li data-type="method" id="PersistentObject-delete-nav"><a href="PersistentObject.html#delete">delete</a></li><li data-type="method" id="PersistentObject-save-nav"><a href="PersistentObject.html#save">save</a></li><li data-type="method" id="PersistentObject-validate-nav"><a href="PersistentObject.html#validate">validate</a></li></ul></li><li id="PluginManager-nav"><a href="PluginManager.html">PluginManager</a><ul class='methods'><li data-type="method" id="PluginManager-canRead-nav"><a href="PluginManager.html#.canRead">canRead</a></li><li data-type="method" id="PluginManager-canWrite-nav"><a href="PluginManager.html#.canWrite">canWrite</a></li><li data-type="method" id="PluginManager-findById-nav"><a href="PluginManager.html#.findById">findById</a></li><li data-type="method" id="PluginManager-getModuleCollection-nav"><a href="PluginManager.html#.getModuleCollection">getModuleCollection</a></li><li data-type="method" id="PluginManager-implementsProtocol-nav"><a href="PluginManager.html#.implementsProtocol">implementsProtocol</a></li><li data-type="method" id="PluginManager-pluginProvides-nav"><a href="PluginManager.html#.pluginProvides">pluginProvides</a></li><li data-type="method" id="PluginManager-setsUp-nav"><a href="PluginManager.html#.setsUp">setsUp</a></li><li data-type="method" id="PluginManager-talksTo-nav"><a href="PluginManager.html#.talksTo">talksTo</a></li><li data-type="method" id="PluginManager-types-nav"><a href="PluginManager.html#.types">types</a></li></ul></li><li id="Popper-nav"><a href="Popper.html">Popper</a><ul class='methods'><li data-type="method" id="Popper-destroy-nav"><a href="Popper.html#.destroy">destroy</a></li><li data-type="method" id="Popper-disableEventListeners-nav"><a href="Popper.html#.disableEventListeners">disableEventListeners</a></li><li data-type="method" id="Popper-enableEventListeners-nav"><a href="Popper.html#.enableEventListeners">enableEventListeners</a></li><li data-type="method" id="Popper-placements-nav"><a href="Popper.html#.placements">placements</a></li><li data-type="method" id="Popper-update-nav"><a href="Popper.html#.update">update</a></li></ul></li><li id="RemoteRepository-nav"><a href="RemoteRepository.html">RemoteRepository</a><ul class='methods'><li data-type="method" id="RemoteRepository-validate-nav"><a href="RemoteRepository.html#validate">validate</a></li></ul></li><li id="S3Client-nav"><a href="S3Client.html">S3Client</a><ul class='methods'><li data-type="method" id="S3Client-description-nav"><a href="S3Client.html#.description">description</a></li><li data-type="method" id="S3Client-download-nav"><a href="S3Client.html#download">download</a></li><li data-type="method" id="S3Client-exists-nav"><a href="S3Client.html#exists">exists</a></li><li data-type="method" id="S3Client-list-nav"><a href="S3Client.html#list">list</a></li><li data-type="method" id="S3Client-upload-nav"><a href="S3Client.html#upload">upload</a></li></ul></li><li id="S3Transfer-nav"><a href="S3Transfer.html">S3Transfer</a><ul class='methods'><li data-type="method" id="S3Transfer-getRemoteUrl-nav"><a href="S3Transfer.html#getRemoteUrl">getRemoteUrl</a></li></ul></li><li id="TarReader-nav"><a href="TarReader.html">TarReader</a><ul class='methods'><li data-type="method" id="TarReader-description-nav"><a href="TarReader.html#.description">description</a></li><li data-type="method" id="TarReader-list-nav"><a href="TarReader.html#list">list</a></li><li data-type="method" id="TarReader-read-nav"><a href="TarReader.html#read">read</a></li></ul></li><li id="TarWriter-nav"><a href="TarWriter.html">TarWriter</a><ul class='methods'><li data-type="method" id="TarWriter-description-nav"><a href="TarWriter.html#.description">description</a></li><li data-type="method" id="TarWriter-add-nav"><a href="TarWriter.html#add">add</a></li></ul></li><li id="TaskDescription-nav"><a href="TaskDescription.html">TaskDescription</a></li><li id="TestUtil-nav"><a href="TestUtil.html">TestUtil</a><ul class='methods'><li data-type="method" id="TestUtil-deleteJsonFile-nav"><a href="TestUtil.html#.deleteJsonFile">deleteJsonFile</a></li><li data-type="method" id="TestUtil-loadProfile-nav"><a href="TestUtil.html#.loadProfile">loadProfile</a></li></ul></li><li id="UploadOperation-nav"><a href="UploadOperation.html">UploadOperation</a><ul class='methods'><li data-type="method" id="UploadOperation-inflateFrom-nav"><a href="UploadOperation.html#.inflateFrom">inflateFrom</a></li><li data-type="method" id="UploadOperation-validate-nav"><a href="UploadOperation.html#validate">validate</a></li></ul></li><li id="UploadTarget-nav"><a href="UploadTarget.html">UploadTarget</a><ul class='methods'><li data-type="method" id="UploadTarget-getValue-nav"><a href="UploadTarget.html#getValue">getValue</a></li><li data-type="method" id="UploadTarget-url-nav"><a href="UploadTarget.html#url">url</a></li><li data-type="method" id="UploadTarget-validate-nav"><a href="UploadTarget.html#validate">validate</a></li></ul></li><li id="Util-nav"><a href="Util.html">Util</a><ul class='methods'><li data-type="method" id="Util-bagNameFromPath-nav"><a href="Util.html#.bagNameFromPath">bagNameFromPath</a></li><li data-type="method" id="Util-boolEqual-nav"><a href="Util.html#.boolEqual">boolEqual</a></li><li data-type="method" id="Util-boolValue-nav"><a href="Util.html#.boolValue">boolValue</a></li><li data-type="method" id="Util-camelToTitle-nav"><a href="Util.html#.camelToTitle">camelToTitle</a></li><li data-type="method" id="Util-cast-nav"><a href="Util.html#.cast">cast</a></li><li data-type="method" id="Util-deleteFromArray-nav"><a href="Util.html#.deleteFromArray">deleteFromArray</a></li><li data-type="method" id="Util-deleteRecursive-nav"><a href="Util.html#.deleteRecursive">deleteRecursive</a></li><li data-type="method" id="Util-escapeBackslashes-nav"><a href="Util.html#.escapeBackslashes">escapeBackslashes</a></li><li data-type="method" id="Util-filterEmptyStrings-nav"><a href="Util.html#.filterEmptyStrings">filterEmptyStrings</a></li><li data-type="method" id="Util-getEnvSetting-nav"><a href="Util.html#.getEnvSetting">getEnvSetting</a></li><li data-type="method" id="Util-getSortFunction-nav"><a href="Util.html#.getSortFunction">getSortFunction</a></li><li data-type="method" id="Util-isEmpty-nav"><a href="Util.html#.isEmpty">isEmpty</a></li><li data-type="method" id="Util-isEmptyStringArray-nav"><a href="Util.html#.isEmptyStringArray">isEmptyStringArray</a></li><li data-type="method" id="Util-lcFirst-nav"><a href="Util.html#.lcFirst">lcFirst</a></li><li data-type="method" id="Util-listContains-nav"><a href="Util.html#.listContains">listContains</a></li><li data-type="method" id="Util-looksLikeEnvSetting-nav"><a href="Util.html#.looksLikeEnvSetting">looksLikeEnvSetting</a></li><li data-type="method" id="Util-looksLikeHypertextURL-nav"><a href="Util.html#.looksLikeHypertextURL">looksLikeHypertextURL</a></li><li data-type="method" id="Util-looksLikeUUID-nav"><a href="Util.html#.looksLikeUUID">looksLikeUUID</a></li><li data-type="method" id="Util-normalizeWindowsPath-nav"><a href="Util.html#.normalizeWindowsPath">normalizeWindowsPath</a></li><li data-type="method" id="Util-tmpFilePath-nav"><a href="Util.html#.tmpFilePath">tmpFilePath</a></li><li data-type="method" id="Util-toHumanSize-nav"><a href="Util.html#.toHumanSize">toHumanSize</a></li><li data-type="method" id="Util-truncateString-nav"><a href="Util.html#.truncateString">truncateString</a></li><li data-type="method" id="Util-unicodeByteLength-nav"><a href="Util.html#.unicodeByteLength">unicodeByteLength</a></li><li data-type="method" id="Util-uuid4-nav"><a href="Util.html#.uuid4">uuid4</a></li><li data-type="method" id="Util-walkSync-nav"><a href="Util.html#.walkSync">walkSync</a></li></ul></li><li id="ValidationOperation-nav"><a href="ValidationOperation.html">ValidationOperation</a><ul class='methods'><li data-type="method" id="ValidationOperation-inflateFrom-nav"><a href="ValidationOperation.html#.inflateFrom">inflateFrom</a></li><li data-type="method" id="ValidationOperation-validate-nav"><a href="ValidationOperation.html#validate">validate</a></li></ul></li><li id="Validator-nav"><a href="Validator.html">Validator</a><ul class='methods'><li data-type="method" id="Validator-_addBagItFile-nav"><a href="Validator.html#_addBagItFile">_addBagItFile</a></li><li data-type="method" id="Validator-_cleanEntryRelPath-nav"><a href="Validator.html#_cleanEntryRelPath">_cleanEntryRelPath</a></li><li data-type="method" id="Validator-_expectedTopLevelFiles-nav"><a href="Validator.html#_expectedTopLevelFiles">_expectedTopLevelFiles</a></li><li data-type="method" id="Validator-_getCryptoHashes-nav"><a href="Validator.html#_getCryptoHashes">_getCryptoHashes</a></li><li data-type="method" id="Validator-_readBag-nav"><a href="Validator.html#_readBag">_readBag</a></li><li data-type="method" id="Validator-_readEntry-nav"><a href="Validator.html#_readEntry">_readEntry</a></li><li data-type="method" id="Validator-_readFile-nav"><a href="Validator.html#_readFile">_readFile</a></li><li data-type="method" id="Validator-_scanBag-nav"><a href="Validator.html#_scanBag">_scanBag</a></li><li data-type="method" id="Validator-_validateFormatAndContents-nav"><a href="Validator.html#_validateFormatAndContents">_validateFormatAndContents</a></li><li data-type="method" id="Validator-_validateManifestEntries-nav"><a href="Validator.html#_validateManifestEntries">_validateManifestEntries</a></li><li data-type="method" id="Validator-_validateNoExtraneousPayloadFiles-nav"><a href="Validator.html#_validateNoExtraneousPayloadFiles">_validateNoExtraneousPayloadFiles</a></li><li data-type="method" id="Validator-_validatePayloadOxum-nav"><a href="Validator.html#_validatePayloadOxum">_validatePayloadOxum</a></li><li data-type="method" id="Validator-_validateProfile-nav"><a href="Validator.html#_validateProfile">_validateProfile</a></li><li data-type="method" id="Validator-_validateRequiredManifests-nav"><a href="Validator.html#_validateRequiredManifests">_validateRequiredManifests</a></li><li data-type="method" id="Validator-_validateSerialization-nav"><a href="Validator.html#_validateSerialization">_validateSerialization</a></li><li data-type="method" id="Validator-_validateSerializationFormat-nav"><a href="Validator.html#_validateSerializationFormat">_validateSerializationFormat</a></li><li data-type="method" id="Validator-_validateTags-nav"><a href="Validator.html#_validateTags">_validateTags</a></li><li data-type="method" id="Validator-_validateTopLevelDirs-nav"><a href="Validator.html#_validateTopLevelDirs">_validateTopLevelDirs</a></li><li data-type="method" id="Validator-_validateTopLevelFiles-nav"><a href="Validator.html#_validateTopLevelFiles">_validateTopLevelFiles</a></li><li data-type="method" id="Validator-_validateUntarDirectory-nav"><a href="Validator.html#_validateUntarDirectory">_validateUntarDirectory</a></li><li data-type="method" id="Validator-fileExtension-nav"><a href="Validator.html#fileExtension">fileExtension</a></li><li data-type="method" id="Validator-getNewReader-nav"><a href="Validator.html#getNewReader">getNewReader</a></li><li data-type="method" id="Validator-payloadFiles-nav"><a href="Validator.html#payloadFiles">payloadFiles</a></li><li data-type="method" id="Validator-payloadManifests-nav"><a href="Validator.html#payloadManifests">payloadManifests</a></li><li data-type="method" id="Validator-readingFromDir-nav"><a href="Validator.html#readingFromDir">readingFromDir</a></li><li data-type="method" id="Validator-readingFromTar-nav"><a href="Validator.html#readingFromTar">readingFromTar</a></li><li data-type="method" id="Validator-tagFiles-nav"><a href="Validator.html#tagFiles">tagFiles</a></li><li data-type="method" id="Validator-tagManifests-nav"><a href="Validator.html#tagManifests">tagManifests</a></li><li data-type="method" id="Validator-validate-nav"><a href="Validator.html#validate">validate</a></li></ul></li></ul><h3 id="global-nav">Global</h3><ul><li><a href="global.html#Config">Config</a></li><li><a href="global.html#Constants">Constants</a></li><li><a href="global.html#dataObject">dataObject</a></li><li><a href="global.html#FATAL_UPLOAD_ERRORS">FATAL_UPLOAD_ERRORS</a></li><li><a href="global.html#loadBuiltInProfiles">loadBuiltInProfiles</a></li><li><a href="global.html#ModifierFn">ModifierFn</a></li><li><a href="global.html#OPTS">OPTS</a></li><li><a href="global.html#pluginTypes">pluginTypes</a></li><li><a href="global.html#referenceObject">referenceObject</a></li><li><a href="global.html#run">run</a></li><li><a href="global.html#runAll">runAll</a></li><li><a href="global.html#tagsByLabel">tagsByLabel</a></li><li><a href="global.html#tagsSetBySystem">tagsSetBySystem</a></li><li><a href="global.html#titleTags">titleTags</a></li><li><a href="global.html#UIConstants">UIConstants</a></li></ul>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        bagit/bagger.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>const { BagItFile } = require('./bagit_file');
const { Constants } = require('../core/constants');
const { Context } = require('../core/context');
const dateFormat = require('dateformat');
const EventEmitter = require('events');
const fs = require('fs');
const { KeyValueCollection } = require('./key_value_collection');
const { OperationResult } = require('../core/operation_result');
const os = require('os');
const path = require('path');
const { PluginManager } = require('../plugins/plugin_manager');
const { Util } = require('../core/util');

/**
 * Bagger creates a bag based on a BagItProfile.
 *
 * @param {Job} job - A job object that includes a
 * {@link PackageOperation} describing a number of files to be
 * packaged and a {@link BagItProfile} describing how to package them.
 *
 * Since bagging is basically a streaming operation, streaming data
 * into a specified format, this class implements a subset of the
 * Node.js stream events. The 'error' and 'finish' events are the
 * primary ones to listen to.
 *
 *
 * @example
 * // Assuming you have already created a Job object
 * var bagger = new Bagger(job);
 * bagger.on('error', function(err) {
 *    // Check the contents of job.packageOperation.result.errors
 *    // for details of what went wrong.
 * });
 * bagger.on('fileAdded', function(bagItFile) {
 *    // Do something with the BagItFile, such as displaying
 *    // a message saying it's been written into the bag.
 *    // Don't alter the bagItFile object since it's still
 *    // in use by the bagger.
 * });
 * bagger.on('finish', function() {
 *     // Do whatever you want when the bag is complete.
 *     // If needed, you can inspect the contents of the bagger.bagItFiles
 *     // array. Manifests and tag files in the bagItFiles array
 *     // will include the file contents. Payload files will not.
 * });
 * bagger.create();
 *
 */
class Bagger extends EventEmitter {
    constructor(job) {
        super();
        /**
         * The Job object contains information about what the bagger
         * is supposed to bag, and according to what profile.
         *
         * @type {Job}
         */
        this.job = job;
        /**
         * This is a list of absolute paths to temporary tag files and
         * manifests. These go into the system temp directory during
         * bagging, and the bagger deletes them when it's done.
         *
         * @type {Array&lt;string>}
         */
        this.tmpFiles = [];
        /**
         * This is a list of {@link BagItFile} objects that were packed
         * into the bag. This includes payload files, manifests, tag files
         * and tag manifests.
         *
         * @type {BagItFile}
         */
        this.bagItFiles = [];
        /**
         * The formatWriter is a plugin used to write the bag onto disk.
         * For example, a bag being written into a directory on the file
         * system will use the FileSystemWriter plugin. A bag being written
         * to a tar file will use the TarWriter plugin, etc.
         *
         * The bagger chooses the formatWriter at runtime, based on
         * heuristics such as the file extension of the output file.
         *
         * @type {object}
         */
        this.formatWriter = null;
    }

    /**
     * This ensures the packaging operation is valid before the bagger
     * tries to run it.
     *
     * @returns {boolean} - True or false, indicating whether or not
     * the job is valid.
     */
    validatePackagingOperation() {
        this.errors = {};
        var packOp = this.job.packageOp;
        if (!packOp.validate()) {
            packOp.result.errors.push("Job is not valid.");
            for(var [key, value] of Object.entries(this.job.errors)) {
                packOp.result.errors.push(`${key}: ${value}`);
            }
            packOp.result.finish();
            return false;
        }
        return true;
    }

    /**
     * This creates the bag based in the BagItProfile and other info specified
     * in the {@link Job} object. See the documentation for the {@link Bagger}
     * class for an example of how to use this method.
     *
     */
    async create() {
        var packOp = this.job.packageOp;
        this.emit('packageStart', `Starting to build ${packOp.packageName}`);
        packOp.result = new OperationResult('bagging', 'DART bagger');
        packOp.result.filepath = packOp.outputPath;
        packOp.result.start();

        if (!this.validatePackagingOperation()) {
            this._finish();
            return false;
        }

        try {
            this._initWriter();
        } catch (ex) {
            packOp.result.errors.push(ex.toString());
            this._finish();
            return false;
        }

        var bagger = this;
        /**
         * @event Bagger#error
         *
         * @description Emits a string describing an error encountered
         * during the bagging process. Processing may continue after
         * some types of errors.
         *
         * @type {string}
         */
        this.formatWriter.on('error', function(err) {
            packOp.result.errors.push(err);
            packOp.result.finish();
            bagger.emit('error', err);
        });
        /**
         * @event Bagger#fileAdded
         *
         * @description Emits a {@link BagItFile} object describing a
         * file that was just written into the bag.
         *
         * @type {BagItFile}
         */
        this.formatWriter.on('fileAdded', function(bagItFile) {
            bagger.emit('fileAdded', bagItFile);
        });

        await this._addPayloadFiles();

        if (!packOp.result.hasErrors()) {
            await this._addTagFiles();
        }
        if (!packOp.result.hasErrors()) {
            await this._addManifests();
        }
        if (!packOp.result.hasErrors()) {
            await this._addTagManifests();
        }

        // Either Node.js streams say they are finished before
        // the final chunk of the final buffer is written to disk
        // or our underlying TarWriter is emitting a drain event
        // prematurely, when the queue is only temporarily drained.
        // When we stat the output file just after our writer says
        // it's finished, we get one size. When we stat it again a
        // few milliseconds later, it's a few hundred bytes larger.
        // We should fix this problem at its root, when we have time
        // to actually find the root. For now, we have this hack to
        // allow the last bit of data to be flushed to disk before
        // we stat the file in the _finish() method.
        await setTimeout(function() { bagger._finish(); }, 300);
    }

    /**
     * This adds payload files to the bag.
     */
    async _addPayloadFiles() {
        var packOp = this.job.packageOp;
        for (var absPath of packOp.sourceFiles) {
            var relDestPath = this._getRelDestPath(absPath);
            var stats = fs.statSync(absPath);
            if (stats.isFile()) {
                await this._addFile(absPath, relDestPath, stats);
            } else if (stats.isDirectory()) {
                // Wait until entire directory is added before
                // attaching finish listener, else queue will
                // drain more than once.
                await this._addDirectory(absPath);
            }
        }
        var bagger = this;
        return new Promise( function(resolve, reject) {
            bagger.formatWriter.once('finish', function() {
                resolve();
            });
        });
    }

    /**
     * Adds a tag file to the bag, writing out all of the tag
     * name-value pairs.
     *
     * @private
     */
    async _addTagFiles(bagItFiles) {
        this._setBagInfoAutoValues();
        var profile = this.job.bagItProfile;
        for (let tagFileName of profile.tagFileNames()) {
            let content = profile.getTagFileContents(tagFileName);
            let tmpFile = path.join(os.tmpdir(), tagFileName + Date.now());
            this.tmpFiles.push(tmpFile);
            fs.writeFileSync(tmpFile, content);
            var stats = fs.statSync(tmpFile);
            await this._addFile(tmpFile, tagFileName, stats);
        }
        let bagger = this;
        return new Promise(function(resolve, reject) {
            bagger.formatWriter.once('finish', function() {
                resolve();
            });
        });
    }

    /**
     * Adds payload manifests to the bag.
     *
     * @private
     */
    async _addManifests() {
        let bagger = this;
        let promise = new Promise(function(resolve, reject) {
            bagger.formatWriter.once('finish', function() {
                resolve();
            });
        });
        await this._writeManifests('payload');
        return promise;
    }

    /**
     * Adds tag manifests to the bag.
     *
     * @private
     */
    async _addTagManifests() {
        let bagger = this;
        let promise = new Promise(function(resolve, reject) {
            bagger.formatWriter.once('finish', function() {
                resolve();
            });
        });
        await bagger._writeManifests('tag');
        return promise;
    }


    /**
     * Adds an entire directory to the bag's payload.
     *
     * @private
     */
    _addDirectory(absPath) {
        let bagger = this;
        let packOp = this.job.packageOp;
        let fsReaderClass = PluginManager.findById(Constants.FILESYSTEM_READER_UUID);
        let fsReader = new fsReaderClass(absPath);
        fsReader.on('entry', function(entry) {
            let fullPath = path.join(absPath, entry.relPath);
            if(entry.fileStat.isFile()) {
                let relDestPath = path.join('data', entry.relPath);
                if (bagger.formatWriter.constructor.name === 'TarWriter') {
                    // For tar files, use forward slash, even on Windows.
                    relDestPath = 'data/' + entry.relPath;
                }
                bagger._addFile(fullPath, relDestPath, entry.fileStat);
            }
        });
        fsReader.on('error', function(err) {
            packOp.result.errors.push(err.toString());
        });
        fsReader.list();
        return new Promise(function(resolve, reject) {
            fsReader.on('end', function(fileCount) {
                resolve(fileCount);
            });
        });
    }

    /**
     * Adds a single file to the bag's payload.
     *
     * @private
     */
    _addFile(absPath, relDestPath, stats) {
        if (os.platform() === 'win32') {
            relDestPath = relDestPath.replace(/\\/g, '/');
        }
        let bagItFile = new BagItFile(absPath, relDestPath, stats);
        let cryptoHashes = this._getCryptoHashes(bagItFile, this.job.bagItProfile.manifestsRequired);
        this.formatWriter.add(bagItFile, cryptoHashes);
        this.bagItFiles.push(bagItFile);
        return new Promise(function(resolve) {
            resolve(bagItFile);
        });
    }

    /**
     * This chooses the plugin that will be used when writing the bag
     * to disk. Tarred bags will use the TarWriter plugin, unserialized
     * bags will use the FileSystemWriter plugin, etc.
     *
     * @private
     */
    _initWriter() {
        if (this.formatWriter) {
            // Don't create another because it will overwrite our output file.
            return;
        }
        var outputPath = this.job.packageOp.outputPath;
        var fileExtension = path.extname(outputPath);
        if (fileExtension === '') {
            fileExtension = 'directory';
        }
        var plugins = PluginManager.canWrite(fileExtension);
        if (!plugins) {
            throw `No plugins know how to write ${fileExtension}`
        }
        // plugins[0] is a writer plugin (a class) with a constructor
        // that takes pathToBag as its sole param.
        this.formatWriter = new plugins[0](outputPath);
    }

    /**
     * Given a file's path on disk this returns the relative path that
     * file will occupy inside the bag.
     *
     * @param {string} absPath - The path of the source file on disk.
     *
     * @returns {string} - The path the file will occupy inside the bag.
     *
     * @private
     */
    _getRelDestPath(absPath) {
        var relDestPath = 'data' + absPath;
        if (os.platform() == 'win32') {
            relDestPath = 'data' + Util.normalizeWindowsPath(absPath);
        }
        return relDestPath;
    }

    /**
     * Sets some automatic values in the bag-info.txt file, including
     * Bagging-Date, Bagging-Software, and Payload-Oxum.
     *
     * @private
     */
    _setBagInfoAutoValues() {
        var profile = this.job.bagItProfile;
        var baggingDate = profile.firstMatchingTag('tagName', 'Bagging-Date');
        if (baggingDate) {
            baggingDate.userValue = dateFormat(Date.now(), 'isoUtcDateTime');
        }

        var baggingSoftware = profile.firstMatchingTag('tagName', 'Bagging-Software');
        if (baggingSoftware) {
            baggingSoftware.userValue = Context.dartVersion();
        }

        var fileCount = 0;
        var byteCount = 0;
        var payloadOxum = profile.firstMatchingTag('tagName', 'Payload-Oxum');
        if (payloadOxum) {
            for (let f of this.bagItFiles) {
                if (f.isPayloadFile()) {
                    fileCount += 1;
                    byteCount += f.size;
                }
            }
            payloadOxum.userValue = `${byteCount}.${fileCount}`;
        }
    }

    /**
     * Deletes temporary manifest and tag files that were generated during
     * the bagging process.
     *
     * @private
     */
    _deleteTempFiles() {
        for (let f of this.tmpFiles) {
            if (fs.existsSync(f)) {
                fs.unlinkSync(f);
            }
        }
    }

    /**
     * Records results of the bagging operation, cleans up temp files,
     * and emits the 'finish' event.
     *
     * @private
     */
    _finish() {
        var result = this.job.packageOp.result;
        result.finish();
        if (fs.existsSync(result.filepath)) {
            let stat = fs.statSync(result.filepath);
            if (stat.isDirectory()) {
                const sum = (total, file) => total + file.size;
                result.filesize = this.bagItFiles.reduce(sum, 0);
            } else {
                result.filesize = stat.size;
            }
        }
        this._deleteTempFiles();
        /**
         * @event Bagger#finish
         *
         * @description Emits an empty event indicating the bagger has
         * completed its work. Check bagger.job.packageOp.result
         * for errors.
         *
         */
        this.emit('finish');
    }


    /**
     * Adds manifests of the specified type to the bag.
     *
     * @param {string} payloadOrTag - Describes whether to add payload
     * or tag manifests.
     *
     * @private
     */
    async _writeManifests(payloadOrTag) {
        var profile = this.job.bagItProfile;
        var manifestAlgs = profile.manifestsRequired;
        var fileNamePrefix = 'manifest';
        if (payloadOrTag == 'tag') {
            manifestAlgs = profile.tagManifestsRequired;
            fileNamePrefix = 'tagmanifest';
        }
        if (manifestAlgs.length == 0) {
            this.formatWriter.emit('finish');
            return;
        }
        for (let algorithm of manifestAlgs) {
            var manifestName = `${fileNamePrefix}-${algorithm}.txt`;
            let tmpFile = path.join(os.tmpdir(), manifestName + Date.now());
            this.tmpFiles.push(tmpFile);
            var fd = fs.openSync(tmpFile, 'w')
            for (let bagItFile of this.bagItFiles) {
                if (payloadOrTag === 'payload' &amp;&amp; !bagItFile.isPayloadFile()) {
                    continue;
                }
                if (payloadOrTag === 'tag' &amp;&amp; (bagItFile.isPayloadFile() || bagItFile.isTagManifest())) {
                    continue;
                }
                let digest = bagItFile.checksums[algorithm];
                fs.writeSync(fd, `${digest} ${bagItFile.relDestPath}\n`);
            }
            fs.closeSync(fd);
            var stats = fs.statSync(tmpFile);
            await this._addFile(tmpFile, manifestName, stats);
        }
    }

    /**
     * Returns a list of cryptographic hash objects that must be calculated
     * on a file as it's written into the bag. DART can calculate multiple
     * digests on a file during a single write.
     *
     * @param {BagItFile} bagItFile - The BagItFile on which to calculate
     * the hash digest.
     *
     * @param {Array&lt;string>} algorithms - The names of the algorithms to
     * calculate. For example, ['md5', 'sha256', 'sha512']. This info comes
     * from the manifestsRequired and tagManifestsRequired properties of the
     * BagItProfile.
     *
     * @returns {Array&lt;object>} - An array of Node.js crypto.Hash objects.
     *
     * @private
     */
    _getCryptoHashes(bagItFile, algorithms) {
        let hashes = [];
        for (let algorithm of algorithms) {
            hashes.push(bagItFile.getCryptoHash(algorithm));
        }
        return hashes;
    }
}

module.exports.Bagger = Bagger;
</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.1</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  

</body>
</html>
